---
- name: Edit BDOS Flood Profiles on DefensePro devices
  hosts: cc
  gather_facts: no

  # Load credential and BDOS edit vars
  vars_files:
    - ../vars/cc.yml
    - ../vars/edit_bdos_vars.yml

  tasks:
    - block:

        - name: üîí Lock DefensePro device(s)
          dp_lock:
            provider: "{{ cc }}"
            dp_ip: "{{ item }}"
          loop: "{{ dp_ip }}"

        - name: ‚úèÔ∏è Edit BDOS Flood Profiles
          vars:
            profile_matrix: "{{ dp_ip | product(bdos_edits) | list }}"
          loop: "{{ profile_matrix }}"
          loop_control:
            label: "{{ item.0 }}/{{ item.1.name }}"
          edit_bdos_profile:
            provider: "{{ cc }}"
            dp_ip: "{{ item.0 }}"
            name: "{{ item.1.name }}"
            params: "{{ item.1.params }}"

      rescue:
        - name: ‚ö†Ô∏è BDOS profile edit failed
          debug:
            msg: "Task '{{ ansible_failed_task.name }}' failed on device {{ item.0 }} ‚Üí Reason: {{ ansible_failed_result.msg | default('unknown') }}"

      always:
        - name: üîì Unlock DefensePro device(s)
          dp_unlock:
            provider: "{{ cc }}"
            dp_ip: "{{ item }}"
          loop: "{{ dp_ip }}"
