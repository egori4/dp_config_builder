---
- name: Create BDOS Profiles on DefensePro devices
  hosts: cc
  gather_facts: no
  vars_files:
    - ../vars/cc.yml
    - ../vars/create_bdos_vars.yml

  tasks:
  - block:
      - name: ğŸ”’ Lock device(s)
        dp_lock:
          provider: "{{ cc }}"
          dp_ip: "{{ item }}"
        loop: "{{ dp_ip }}"

      - name: ğŸš€ Create BDOS profiles on each device
        vars:
          profile_matrix: "{{ dp_ip | product(bdos_mappings) | list }}"
        loop: "{{ profile_matrix }}"
        loop_control:
          label: "{{ item.0 }}/{{ item.1.name }}"
        create_bdos_profile:
          provider: "{{ cc }}"
          dp_ip: "{{ item.0 }}"
          name: "{{ item.1.name }}"
          params: "{{ item.1.params }}"

    rescue:
      - debug:
          msg: "âš ï¸ BDOS creation failed â†’ Task: {{ ansible_failed_task.name }} / Reason: {{ ansible_failed_result.msg | default('unknown') }}"

    always:
      - name: ğŸ”“ Unlock device(s)
        dp_unlock:
          provider: "{{ cc }}"
          dp_ip: "{{ item }}"
        loop: "{{ dp_ip }}"
